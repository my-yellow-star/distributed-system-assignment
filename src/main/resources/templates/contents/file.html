<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}"
      lang="ko">

<th:block layout:fragment="content">
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <div id="wrapper">
        <div id="content-wrapper" class="d-flex flex-column">
            <div id="content">
                <h1>Ku:Loud</h1>
                <form>
                    <input type="file" id="fileInput" name="fileInput">
                    <button type="button" id="uploadButton">Upload</button>
                </form>
            </div>
        </div>
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion p-1" id="accordionSidebar">
            <div class="text-light text-center">[[${user.name}]]님 환영합니다.</div>
            <a th:href="@{/logout}" class="btn btn-secondary btn-block">로그아웃</a>
            <div class="text-white" style="padding-top: 60px">
                <p class="small">접속 기록</p>
            </div>
            <div id="welcome" class="col p-0 text-gray-100 text-white-50"></div>
        </ul>
    </div>
    <script th:inline="javascript">
        let user = [[${user}]];
        let socket = new WebSocket("ws://" + location.host + "/upload?userId=" + user.id);
        function upload() {
            let file =  $("#fileInput")[0].files[0];
            let reader = new FileReader();
            socket.send(JSON.stringify({
                "type": "START_FILE_UPLOAD",
                "fileName": file.name
            }))
            reader.onload = function () {
                let content = reader.result;
                socket.send(content);
            };
            reader.readAsArrayBuffer(file);
        }

        function handleTextMessage(json) {
            let welcome = $("#welcome");
            let type = json["type"];
            switch (type) {
                case "enter":
                    welcome.append(`<p class="p-0 small">${json['name']}님이 접속하셨습니다.<br>세션: ${json['session']}</p>`);
                    break;
                case "exit":
                    welcome.append(`<p class="p-0 small">${json['name']}님이 퇴장하셨습니다.<br>세션: ${json['session']}</p>`);
                    break;
            }
        }

        $("#uploadButton").click(upload);

        socket.onmessage = function (event) {
            if (event.data instanceof Blob) {

            } else {
                let json = JSON.parse(event.data);
                handleTextMessage(json);
            }
        };
    </script>
</th:block>
</html>
